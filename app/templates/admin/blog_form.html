{% extends "admin/admin_base.html" %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-newspaper"></i> {{ title }}</h4>
    <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay lại
    </a>
</div>

<div class="row">
    <!-- LEFT: Main Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="blogForm">
                    {{ form.hidden_tag() }}

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Tiêu đề bài viết *</label>
                            {{ form.title(class="form-control", id="blogTitle", placeholder="Nhập tiêu đề bài viết") }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Slug (URL) *</label>
                            {{ form.slug(class="form-control", id="blogSlug", placeholder="tieu-de-bai-viet") }}
                            {% if form.slug.errors %}
                                <div class="text-danger small mt-1">{{ form.slug.errors[0] }}</div>
                            {% endif %}
                            <small class="text-muted">Tự động từ tiêu đề</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Mô tả ngắn (Excerpt)</label>
                            {{ form.excerpt(class="form-control", id="blogExcerpt", rows="3", placeholder="Tóm tắt nội dung bài viết") }}
                            <small class="text-muted">Tối đa 200 ký tự</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Nội dung bài viết *</label>
                            {{ form.content(class="form-control", id="editor", rows="15", placeholder="Viết nội dung đầy đủ ở đây...") }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Hình ảnh đại diện</label>
                            <div class="input-group">
                                {{ form.image(class="form-control", id="image") }}
                                <button type="button" class="btn btn-warning" onclick="openMediaPicker('image', 'imagePreview')">
                                    <i class="bi bi-images"></i> Chọn từ thư viện
                                </button>
                            </div>
                            <small class="text-muted">Khuyến nghị: 800x500px (Max 16MB)</small>

                            <input type="hidden" name="selected_image_path" id="selectedImagePath" value="">

                            <div class="mt-2">
                                <img id="imagePreview" src="{% if blog and blog.image %}{{ blog.image }}{% endif %}" alt="Preview" class="img-thumbnail" style="max-height: 150px; {% if not blog or not blog.image %}display: none;{% endif %}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Tác giả</label>
                            {{ form.author(class="form-control", placeholder="Tên tác giả") }}
                            <small class="text-muted">Để trống sẽ lấy tên user hiện tại</small>
                        </div>

                        <!-- SEO SECTION -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h5 class="text-warning mb-3">
                                <i class="bi bi-graph-up-arrow"></i> Tối ưu SEO
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Focus Keyword *</label>
                            {{ form.focus_keyword(class="form-control", id="focusKeyword", placeholder="VD: Keo dán gạch Bricon") }}
                            <small class="text-muted">Từ khóa chính muốn xếp hạng trên Google</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Meta Title (SEO Title)</label>
                            {{ form.meta_title(class="form-control", id="metaTitle", placeholder="Tự động từ tiêu đề nếu để trống") }}
                            <small class="text-muted">
                                <span id="metaTitleCount">0</span>/60 ký tự
                                <span class="badge bg-info" id="titleStatus">Tối ưu: 30-60 ký tự</span>
                            </small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Meta Description</label>
                            {{ form.meta_description(class="form-control", rows="3", id="metaDesc", placeholder="Mô tả ngắn gọn cho Google Search") }}
                            <small class="text-muted">
                                <span id="metaDescCount">0</span>/160 ký tự
                                <span class="badge bg-info" id="descStatus">Tối ưu: 120-160 ký tự</span>
                            </small>
                        </div>

                        <!-- SEO Preview -->
                        <div class="col-12">
                            <div class="card bg-light border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-google"></i> Preview Google Search
                                </div>
                                <div class="card-body">
                                    <div id="seoPreview">
                                        <div class="text-primary fw-bold" style="font-size: 20px; line-height: 1.3;" id="previewTitle">
                                            Tiêu đề bài viết sẽ hiển thị ở đây...
                                        </div>
                                        <div class="text-success" style="font-size: 14px; margin: 4px 0;">
                                            <span>tendoanhnghiep.com.vn</span> › tin-tuc › <span id="previewSlug">slug</span>
                                        </div>
                                        <div class="text-muted" style="font-size: 14px; line-height: 1.5;" id="previewDesc">
                                            Mô tả sẽ hiển thị ở đây...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_featured(class="form-check-input") }}
                                <label class="form-check-label" for="{{ form.is_featured.id }}">
                                    <i class="bi bi-star"></i> Đánh dấu là bài viết nổi bật
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_active(class="form-check-input", checked=true) }}
                                <label class="form-check-label" for="{{ form.is_active.id }}">
                                    Kích hoạt hiển thị
                                </label>
                            </div>
                        </div>

                        <div class="col-12 mt-4">
                            {{ form.submit(class="btn btn-warning px-5") }}
                            <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">Hủy</a>
                            <button type="button" class="btn btn-info ms-2" id="checkSeoBtn">
                                <i class="bi bi-search"></i> Kiểm tra SEO
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- RIGHT: SEO Score Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 100px;">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-speedometer2"></i> Điểm SEO</h5>
            </div>
            <div class="card-body">
                <div id="seoScorePanel">
                    <!-- Loading state -->
                    <div class="text-center py-4" id="seoLoading">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Đang phân tích SEO...</p>
                    </div>

                    <!-- Score display (hidden by default) -->
                    <div id="seoResult" style="display: none;">
                        <!-- Score Circle -->
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <svg width="150" height="150">
                                    <circle cx="75" cy="75" r="65" fill="none" stroke="#e9ecef" stroke-width="12"></circle>
                                    <circle id="scoreCircle" cx="75" cy="75" r="65" fill="none" stroke="#ffc107" stroke-width="12"
                                            stroke-dasharray="408" stroke-dashoffset="408"
                                            style="transition: stroke-dashoffset 1s ease; transform: rotate(-90deg); transform-origin: center;">
                                    </circle>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <h2 class="mb-0 fw-bold" id="scoreNumber">0</h2>
                                    <small class="text-muted">/ 100</small>
                                    <div class="mt-1">
                                        <span class="badge" id="scoreBadge">F</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist -->
                        <h6 class="fw-bold mb-3">Checklist SEO:</h6>
                        <div id="seoChecklist" class="small">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <!-- Recommendations -->
                        <div id="seoRecommendations" class="mt-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'admin/components/media_picker_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-generate slug from title
document.querySelector('input[name="title"]').addEventListener('input', function(e) {
    const slug = e.target.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    document.querySelector('input[name="slug"]').value = slug;
    updateSEOPreview();
});
</script>

<script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
<script>
let editorInstance;
ClassicEditor.create(document.querySelector('#editor'))
    .then(editor => {
        editorInstance = editor;
        const textarea = document.querySelector('#editor');
        textarea.removeAttribute('required');

        // Check SEO when content changes
        editor.model.document.on('change:data', () => {
            debounceCheckSEO();
        });

        document.querySelector('form').addEventListener('submit', function(e) {
            const content = editorInstance.getData().trim();
            textarea.value = content;
            if (!content) {
                e.preventDefault();
                alert('Vui lòng nhập nội dung bài viết');
                editorInstance.focus();
                return false;
            }
        });
    })
    .catch(error => {
        console.error('Lỗi khởi tạo CKEditor:', error);
    });
</script>

<script>
// Character counters và SEO Preview
const metaTitle = document.getElementById('metaTitle');
const metaDesc = document.getElementById('metaDesc');
const titleInput = document.getElementById('blogTitle');
const slugInput = document.getElementById('blogSlug');
const focusKeyword = document.getElementById('focusKeyword');

function updateCharCount(input, counterId, statusId, min, max) {
    const count = input.value.length;
    const counter = document.getElementById(counterId);
    const status = document.getElementById(statusId);

    counter.textContent = count;

    if (count >= min && count <= max) {
        status.className = 'badge bg-success';
        status.textContent = 'Tối ưu';
    } else if (count > 0) {
        status.className = 'badge bg-warning';
        status.textContent = count < min ? 'Hơi ngắn' : 'Hơi dài';
    } else {
        status.className = 'badge bg-secondary';
        status.textContent = `Tối ưu: ${min}-${max} ký tự`;
    }
}

function updateSEOPreview() {
    const title = metaTitle.value || titleInput.value || 'Tiêu đề bài viết sẽ hiển thị ở đây...';
    const desc = metaDesc.value || document.getElementById('blogExcerpt').value || 'Mô tả sẽ hiển thị ở đây...';
    const slug = slugInput.value || 'slug';

    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDesc').textContent = desc.substring(0, 160) + (desc.length > 160 ? '...' : '');
    document.getElementById('previewSlug').textContent = slug;
}

// Event listeners
if (metaTitle) {
    metaTitle.addEventListener('input', function() {
        updateCharCount(this, 'metaTitleCount', 'titleStatus', 30, 60);
        updateSEOPreview();
        debounceCheckSEO();
    });
    updateCharCount(metaTitle, 'metaTitleCount', 'titleStatus', 30, 60);
}

if (metaDesc) {
    metaDesc.addEventListener('input', function() {
        updateCharCount(this, 'metaDescCount', 'descStatus', 120, 160);
        updateSEOPreview();
        debounceCheckSEO();
    });
    updateCharCount(metaDesc, 'metaDescCount', 'descStatus', 120, 160);
}

if (titleInput) {
    titleInput.addEventListener('input', () => {
        updateSEOPreview();
        debounceCheckSEO();
    });
}

if (slugInput) {
    slugInput.addEventListener('input', updateSEOPreview);
}

if (focusKeyword) {
    focusKeyword.addEventListener('input', debounceCheckSEO);
}

// Initial preview
updateSEOPreview();

// Debounce function
let seoCheckTimeout;
function debounceCheckSEO() {
    clearTimeout(seoCheckTimeout);
    seoCheckTimeout = setTimeout(checkSEO, 1500);
}

// Check SEO via AJAX
function checkSEO() {
    const data = {
        title: titleInput.value,
        content: editorInstance ? editorInstance.getData() : '',
        focus_keyword: focusKeyword.value,
        meta_title: metaTitle.value,
        meta_description: metaDesc.value,
        image: document.getElementById('selectedImagePath').value || ''
    };

    // Show loading
    document.getElementById('seoLoading').style.display = 'block';
    document.getElementById('seoResult').style.display = 'none';

    fetch('/admin/api/check-blog-seo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        displaySEOResult(result);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('seoLoading').innerHTML = '<p class="text-danger">Lỗi khi kiểm tra SEO</p>';
    });
}

function displaySEOResult(result) {
    document.getElementById('seoLoading').style.display = 'none';
    document.getElementById('seoResult').style.display = 'block';

    // Update score
    const score = result.score;
    const scoreCircle = document.getElementById('scoreCircle');
    const circumference = 408;
    const offset = circumference - (score / 100) * circumference;

    scoreCircle.style.strokeDashoffset = offset;
    scoreCircle.style.stroke = getScoreColor(result.grade_class);

    document.getElementById('scoreNumber').textContent = score;

    const badge = document.getElementById('scoreBadge');
    badge.textContent = result.grade + ' - ' + result.grade_text;
    badge.className = 'badge bg-' + result.grade_class;

    // Update checklist
    let checklistHTML = '<ul class="list-unstyled">';
    result.checklist.forEach(item => {
        const iconClass = {
            'success': 'bi-check-circle-fill text-success',
            'info': 'bi-info-circle-fill text-info',
            'warning': 'bi-exclamation-triangle-fill text-warning',
            'danger': 'bi-x-circle-fill text-danger'
        }[item[0]];

        checklistHTML += `<li class="mb-2"><i class="bi ${iconClass}"></i> ${item[1]}</li>`;
    });
    checklistHTML += '</ul>';
    document.getElementById('seoChecklist').innerHTML = checklistHTML;

    // Update recommendations
    if (result.recommendations && result.recommendations.length > 0) {
        let recHTML = '<h6 class="fw-bold text-warning mt-3">Khuyến nghị:</h6><ul class="small">';
        result.recommendations.forEach(rec => {
            recHTML += `<li class="mb-1">${rec}</li>`;
        });
        recHTML += '</ul>';
        document.getElementById('seoRecommendations').innerHTML = recHTML;
    } else {
        document.getElementById('seoRecommendations').innerHTML = '<p class="text-success small mt-3"><i class="bi bi-check-circle"></i> SEO tốt, không có khuyến nghị thêm!</p>';
    }
}

function getScoreColor(gradeClass) {
    const colors = {
        'success': '#28a745',
        'info': '#17a2b8',
        'warning': '#ffc107',
        'danger': '#dc3545'
    };
    return colors[gradeClass] || '#6c757d';
}

// Manual check button
document.getElementById('checkSeoBtn').addEventListener('click', checkSEO);

// Auto-check on page load if editing existing blog
window.addEventListener('load', function() {
    {% if blog %}
    setTimeout(checkSEO, 500);
    {% endif %}
});
</script>
{% endblock %}